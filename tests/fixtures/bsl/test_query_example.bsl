// === ОПТИМИЗИРОВАННЫЙ ЗАПРОС С ВРЕМЕННОЙ ТАБЛИЦЕЙ ===
	ТекстЗапроса = "ВЫБРАТЬ
		|	ДокументыПредприятия.Ссылка КАК Документ,
		|	ЕСТЬNULL(ДатаДокумента.Значение, ДАТАВРЕМЯ(1, 1, 1)) КАК ДатаДокумента,
		|	ТипДоговора.Значение КАК ТипДоговора,
		|	ДокументыПредприятия.Контрагент КАК Контрагент,
		|	ДокументыПредприятия.Организация КАК Организация
		|ПОМЕСТИТЬ ВременнаяТаблицаОсновныеДокументы
		|ИЗ
		|	Справочник.ДокументыПредприятия КАК ДокументыПредприятия
		|		// Получаем дату документа
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДокументыПредприятия.ДополнительныеРеквизиты КАК ДатаДокумента
		|		ПО ДокументыПредприятия.Ссылка = ДатаДокумента.Ссылка
		|			И ДатаДокумента.Свойство = &СвойствоДатаДокумента
		|		// Получаем тип договора (обязательно)
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ДокументыПредприятия.ДополнительныеРеквизиты КАК ТипДоговора
		|		ПО ДокументыПредприятия.Ссылка = ТипДоговора.Ссылка
		|			И ТипДоговора.Свойство = &СвойствоТипДоговора
		|		// Проверка наличия обязательной организации (стороны)
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ДокументыПредприятия.Стороны КАК Орг
		|		ПО ДокументыПредприятия.Ссылка = Орг.Ссылка
		|			И Орг.Сторона = &Орг
		|		// Проверка для опционального КА
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДокументыПредприятия.Контрагенты КАК КА
		|		ПО ДокументыПредприятия.Ссылка = КА.Ссылка
		|			И КА.Контрагент = &КА
		|ГДЕ
		|	ДокументыПредприятия.ВидДокумента = &ВидДокумента
		|	И НЕ ДокументыПредприятия.ПометкаУдаления
		|	И ТипДоговора.Значение = &ТипДоговора
		|	И ЕСТЬNULL(ДатаДокумента.Значение, ДАТАВРЕМЯ(1, 1, 1)) МЕЖДУ &ДНач И &ДКон
		|	// Условие для опционального КА
		|	И ВЫБОР КОГДА &ИспользоватьОтборПоКА
		|		ТОГДА КА.Ссылка ЕСТЬ НЕ NULL
		|		ИНАЧЕ ИСТИНА
		|	КОНЕЦ
		|СГРУППИРОВАТЬ ПО
		|	ДокументыПредприятия.Ссылка,
		|	ЕСТЬNULL(ДатаДокумента.Значение, ДАТАВРЕМЯ(1, 1, 1)),
		|	ТипДоговора.Значение,
		|	ДокументыПредприятия.Контрагент,
		|	ДокументыПредприятия.Организация;
		|
		|// Подсчитываем количество организаций для исключения у каждого документа
		|ВЫБРАТЬ
		|	ВременнаяТаблицаОсновныеДокументы.Документ,
		|	ВременнаяТаблицаОсновныеДокументы.ДатаДокумента,
		|	ВременнаяТаблицаОсновныеДокументы.ТипДоговора,
		|	ВременнаяТаблицаОсновныеДокументы.Контрагент,
		|	ВременнаяТаблицаОсновныеДокументы.Организация,
		|	КОЛИЧЕСТВО(ИсключаемыеСтороны.Ссылка) КАК КоличествоНайденныхОрганизаций
		|ПОМЕСТИТЬ ВременнаяТаблицаСПодсчетом
		|ИЗ
		|	ВременнаяТаблицаОсновныеДокументы КАК ВременнаяТаблицаОсновныеДокументы
		|		// Подсчитываем найденные организации для исключения
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДокументыПредприятия.Стороны КАК ИсключаемыеСтороны
		|		ПО ВременнаяТаблицаОсновныеДокументы.Документ = ИсключаемыеСтороны.Ссылка
		|			И ИсключаемыеСтороны.Сторона В(&ОрганизацииДляИсключения)
		|СГРУППИРОВАТЬ ПО
		|	ВременнаяТаблицаОсновныеДокументы.Документ,
		|	ВременнаяТаблицаОсновныеДокументы.ДатаДокумента,
		|	ВременнаяТаблицаОсновныеДокументы.ТипДоговора,
		|	ВременнаяТаблицаОсновныеДокументы.Контрагент,
		|	ВременнаяТаблицаОсновныеДокументы.Организация;
		|
		|ВЫБРАТЬ
		|	ВременнаяТаблицаСПодсчетом.Документ,
		|	ВременнаяТаблицаСПодсчетом.ДатаДокумента,
		|	ВременнаяТаблицаСПодсчетом.ТипДоговора,
		|	ВременнаяТаблицаСПодсчетом.Контрагент,
		|	ВременнаяТаблицаСПодсчетом.Организация
		|ИЗ
		|	ВременнаяТаблицаСПодсчетом КАК ВременнаяТаблицаСПодсчетом
		|ГДЕ
		|	// Исключаем документы только если у них есть ВСЕ организации для исключения
		|	ВЫБОР КОГДА &ЕстьОрганизацииДляИсключения
		|		ТОГДА ВременнаяТаблицаСПодсчетом.КоличествоНайденныхОрганизаций < &КоличествоОрганизацийДляИсключения
		|		ИНАЧЕ ИСТИНА
		|	КОНЕЦ";
	
	Запрос = Новый Запрос(ТекстЗапроса);