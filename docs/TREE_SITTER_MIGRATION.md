# План миграции на tree-sitter-bsl

## Обоснование миграции

### Проблемы текущего парсера (nom-based)
1. **Неполная поддержка BSL синтаксиса**:
   - Не поддерживает комментарии внутри блоков кода
   - Нет поддержки многострочных строк через `|`
   - Отсутствуют препроцессорные директивы (`#Если`, `#Область`)
   - Нет async/await конструкций
   - Не поддерживает аннотации (`&НаКлиенте`, `&НаСервере`)

2. **Отсутствие устойчивости к ошибкам**:
   - Парсер падает при первой синтаксической ошибке
   - Невозможно получить частичное AST для некорректного кода

3. **Проблемы с производительностью LSP**:
   - Полный репарсинг файла при каждом изменении
   - Нет инкрементального парсинга

### Преимущества tree-sitter-bsl
1. **Полная поддержка BSL**:
   - Все конструкции языка из коробки
   - Поддержка обеих нотаций (русская/английская)
   - Корректные приоритеты операторов

2. **Инкрементальный парсинг**:
   - Обновляет только изменившиеся части AST
   - Критично для производительности LSP

3. **Устойчивость к ошибкам**:
   - Продолжает парсинг даже при синтаксических ошибках
   - Возвращает частичное AST с маркерами ошибок

4. **Зрелость решения**:
   - Используется в production (VS Code расширения)
   - Активно поддерживается сообществом
   - Хорошо протестирована

## План миграции

### Phase 1: Подготовка (1-2 дня)
- [ ] Изучить API tree-sitter для Rust
- [ ] Добавить зависимости в Cargo.toml:
  ```toml
  [dependencies]
  tree-sitter = "0.20"
  tree-sitter-bsl = { git = "https://github.com/alkoleft/tree-sitter-bsl" }
  ```
- [ ] Создать модуль `src/parser/tree_sitter_adapter.rs`

### Phase 2: Создание адаптера (3-5 дней)
- [ ] Реализовать trait `Parser` для tree-sitter:
  ```rust
  pub trait Parser {
      fn parse(&mut self, source: &str) -> Result<Program>;
  }
  ```
- [ ] Создать конвертер tree-sitter AST → наш AST:
  ```rust
  pub struct TreeSitterAdapter {
      parser: tree_sitter::Parser,
  }
  
  impl TreeSitterAdapter {
      pub fn convert_node(&self, node: Node) -> Expression {
          // Конвертация узлов
      }
  }
  ```
- [ ] Маппинг основных конструкций:
  - Выражения (binary, unary, call, etc.)
  - Statements (if, while, for, etc.)
  - Declarations (function, procedure, var)

### Phase 3: Параллельная работа (1 неделя)
- [ ] Добавить feature flag для выбора парсера:
  ```toml
  [features]
  tree-sitter-parser = []
  nom-parser = []
  default = ["nom-parser"]
  ```
- [ ] Создать фабрику парсеров:
  ```rust
  pub fn create_parser(use_tree_sitter: bool) -> Box<dyn Parser> {
      if use_tree_sitter {
          Box::new(TreeSitterParser::new())
      } else {
          Box::new(BslParser::new())
      }
  }
  ```
- [ ] Запустить параллельное тестирование

### Phase 4: Миграция тестов (3-4 дня)
- [ ] Адаптировать unit тесты для обоих парсеров
- [ ] Создать сравнительные бенчмарки
- [ ] Добавить тесты для новых возможностей:
  - Комментарии в блоках
  - Многострочные строки
  - Препроцессор
  - Async/await

### Phase 5: Интеграция с LSP (2-3 дня)
- [ ] Реализовать инкрементальный парсинг:
  ```rust
  pub fn update_incremental(
      &mut self,
      old_tree: &Tree,
      edit: &InputEdit
  ) -> Tree
  ```
- [ ] Обновить LSP сервер для использования нового парсера
- [ ] Добавить диагностику синтаксических ошибок

### Phase 6: Полная миграция (1-2 дня)
- [ ] Сделать tree-sitter парсер по умолчанию
- [ ] Удалить старый nom-based парсер
- [ ] Обновить документацию

## Риски и митигация

### Риск 1: Несовместимость AST структур
**Митигация**: Создать промежуточный слой адаптации, который конвертирует tree-sitter AST в наш формат.

### Риск 2: Различия в обработке edge cases
**Митигация**: Обширное тестирование на реальных BSL файлах из production кода.

### Риск 3: Производительность конвертации AST
**Митигация**: Lazy конвертация - конвертировать только те части AST, которые реально используются.

## Метрики успеха

1. **Функциональность**:
   - [ ] Все существующие тесты проходят
   - [ ] Поддержка новых конструкций языка

2. **Производительность**:
   - [ ] Парсинг файла 10000 строк < 200ms
   - [ ] Инкрементальное обновление < 10ms
   - [ ] Память: не более 2x от размера исходного файла

3. **Надёжность**:
   - [ ] Корректный парсинг 95% файлов с синтаксическими ошибками
   - [ ] Нет падений парсера на любом входе

## Временная оценка

**Общая оценка**: 2-3 недели

- Подготовка: 1-2 дня
- Разработка адаптера: 3-5 дней
- Параллельная работа: 1 неделя
- Миграция тестов: 3-4 дня
- Интеграция с LSP: 2-3 дня
- Финализация: 1-2 дня

## Ресурсы

- [tree-sitter documentation](https://tree-sitter.github.io/tree-sitter/)
- [tree-sitter-bsl repository](https://github.com/alkoleft/tree-sitter-bsl)
- [tree-sitter Rust bindings](https://docs.rs/tree-sitter/latest/tree_sitter/)
- [Incremental parsing guide](https://tree-sitter.github.io/tree-sitter/using-parsers#editing)