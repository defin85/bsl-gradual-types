# BSL Gradual Type System

Современная система градуальной типизации для языка 1С:Предприятие BSL, объединяющая статический анализ с runtime контрактами.

## 🎯 Ключевые возможности

- **Градуальная типизация** - Плавный переход от динамической к статической типизации
- **Эволюционная архитектура** - Начинаем с MVP, расширяем без breaking changes
- **Pipeline разрешения типов** - Уровни уверенности с множественными источниками
- **Фасетная система** - Поддержка разных представлений одного типа
- **Runtime контракты** - Динамическая проверка типов для неопределённых случаев
- **Парсер запросов 1С** - Полная поддержка языка запросов с временными таблицами

## 🚀 Быстрый старт

```bash
# Сборка проекта
cargo build --release

# Анализ BSL файла
cargo run --bin bsl-analyzer -- --file module.bsl

# Запуск LSP сервера
cargo run --bin lsp-server

# Проверка типов
cargo run --bin type-check -- --file module.bsl

# Демонстрация парсера запросов
cargo run --example query_demo
```

## 📊 Обзор архитектуры

Система построена на слоистой архитектуре, позволяющей инкрементальную разработку:

### Ключевые концепции

1. **TypeResolution** - Не тип, а разрешение с уровнем уверенности
2. **Уровни уверенности** - Known, Inferred(0.0-1.0), Unknown
3. **Фасеты** - Множественные представления типа (Manager, Object, Reference, Metadata)
4. **Градуальная информация** - Статический тип + Динамический контракт

### Слои архитектуры

```
┌─────────────────────────────────────────┐
│         Application Layer               │
│   (LSP Server, CLI Tools, Extensions)   │
├─────────────────────────────────────────┤
│         Analysis Layer                  │
│   (Parser, Type Checker, Query Analyzer)│
├─────────────────────────────────────────┤
│         Resolution Layer                │
│   (Type Resolver, Context Resolver)     │
├─────────────────────────────────────────┤
│           Core Layer                    │
│   (Types, Facets, Contracts)           │
├─────────────────────────────────────────┤
│         Adapter Layer                   │
│   (Platform Docs, Config Parser)        │
└─────────────────────────────────────────┘
```

## 🔄 Дорожная карта разработки

### ✅ Phase 1: MVP (Завершена)
- [x] Базовое разрешение типов с уровнями уверенности
- [x] Полная фасетная система (Manager, Object, Reference, Constructor)
- [x] Основные структуры данных и абстракции
- [x] Загрузка платформенных типов (хардкод с TODO)
- [x] Парсинг Configuration.xml с табличными частями
- [x] LSP сервер с hover и completion
- [x] Генерация runtime контрактов

### ✅ Phase 2: Анализ кода (Завершена)
- [x] BSL парсер на основе nom combinators
- [x] Генерация AST (Abstract Syntax Tree)
- [x] Visitor pattern для обхода AST
- [x] Граф зависимостей типов с обнаружением циклов
- [x] Type checker с выводом типов
- [x] Проверка совместимости типов
- [x] Диагностики в LSP (ошибки, предупреждения)
- [x] Контекстно-зависимое разрешение типов

### ✅ Phase 3: Поддержка запросов (Завершена)
- [x] Парсер языка запросов 1С
- [x] Поддержка составных имён таблиц (Документ.ПоступлениеТоваровУслуг)
- [x] Временные таблицы (ПОМЕСТИТЬ/ИЗ ВТ_)
- [x] Пакетные запросы с анализом зависимостей
- [x] JOIN операции (ЛЕВОЕ/ПРАВОЕ/ПОЛНОЕ/ВНУТРЕННЕЕ СОЕДИНЕНИЕ)
- [x] Агрегатные функции и GROUP BY
- [x] Подзапросы и UNION
- [x] Интеграция с системой типов

### ✅ Phase 3.5: Парсер синтакс-помощника (Завершена)
- [x] Парсер ZIP архивов синтакс-помощника
- [x] Извлечение глобальных функций и их сигнатур (476 функций)
- [x] Извлечение глобальных объектов (60 объектов: Array, String, Map и др.)
- [x] Парсинг системных перечислений (712 перечислений с значениями)
- [x] Извлечение методов объектов (5617 методов)
- [x] Извлечение свойств объектов (12044 свойства)
- [x] Парсинг ключевых слов с правильной категоризацией (22 слова)
- [x] Система TypeRef для нормализации типов
- [x] Интеграция с FacetRegistry и PlatformTypeResolver
- [x] Кеширование фасетов (FacetCache)
- [x] Визуализация с правильной иерархией языка
- [x] Интеграция новых типов в LSP для автодополнения

### ✅ Phase 3.6: Оптимизация и визуализация (Завершена)
- [x] Многопоточный парсинг с rayon (ускорение в 4-8 раз)
- [x] Единая унифицированная версия парсера
- [x] Извлечение человекочитаемых категорий (276 категорий)
- [x] Интерактивная HTML визуализация с вкладками
- [x] Поиск и фильтрация по категориям
- [x] Система фасетов в визуализации
- [x] Двуязычные индексы (русский/английский)

### 📋 Phase 4: Расширенный анализ (Запланировано)
- [ ] Flow-sensitive анализ типов
- [ ] Межпроцедурный анализ
- [ ] Type narrowing в условиях
- [ ] Обнаружение мёртвого кода
- [ ] Оптимизация запросов

### Phase 5: Интеграция с платформой
- [ ] Парсер документации платформы
- [ ] Реальные типы платформы из ITS/HTML документации
- [ ] Индексация метаданных конфигурации
- [ ] Межмодульное отслеживание типов

### Phase 6: Оптимизация и ML
- [ ] Инкрементальный анализ
- [ ] Параллельная проверка типов
- [ ] ML-based предсказания типов
- [ ] Инструменты профилирования

## 🏗️ Структура проекта

```
bsl-gradual-types/
├── src/
│   ├── core/                    # Ядро системы типов
│   │   ├── types.rs            # Определения типов и разрешение
│   │   ├── resolution.rs       # Pipeline разрешения типов
│   │   ├── contracts.rs        # Генерация runtime контрактов
│   │   ├── facets.rs           # Фасетная система
│   │   ├── context.rs          # Контекстно-зависимое разрешение
│   │   ├── dependency_graph.rs # Граф зависимостей типов
│   │   ├── type_checker.rs     # Проверка и вывод типов
│   │   └── standard_types.rs   # Стандартные типы BSL
│   ├── parser/                  # BSL парсер
│   │   ├── lexer.rs            # Токенизация
│   │   ├── parser.rs           # Синтаксический анализ (nom)
│   │   ├── ast.rs              # Abstract Syntax Tree
│   │   ├── visitor.rs          # Visitor pattern для AST
│   │   └── graph_builder.rs    # Построение графа зависимостей
│   ├── query/                   # Парсер запросов 1С
│   │   ├── parser.rs           # Парсер языка запросов
│   │   ├── ast.rs              # AST для запросов
│   │   ├── batch.rs            # Пакетные запросы
│   │   └── type_checker.rs     # Проверка типов в запросах
│   ├── adapters/                # Адаптеры внешних данных
│   │   ├── config_parser_xml.rs # Парсер Configuration.xml
│   │   └── syntax_helper_parser.rs # Парсер синтакс-помощника
│   └── bin/                     # Исполняемые файлы
│       ├── analyzer.rs          # CLI анализатор
│       ├── lsp_server.rs        # Language Server Protocol
│       ├── build_index.rs       # Построитель индекса типов
│       └── type_check.rs        # CLI проверка типов
├── tests/                       # Тесты
│   ├── integration/            # Интеграционные тесты
│   └── fixtures/               # Тестовые данные
│       ├── bsl/               # BSL файлы
│       ├── xml/               # XML конфигурации
│       └── queries/           # Примеры запросов
├── examples/                    # Примеры использования
│   ├── query_demo.rs           # Демо парсера запросов
│   └── queries/                # Примеры запросов 1С
├── docs/                        # Документация
│   ├── ARCHITECTURE.md         # Архитектура системы
│   ├── MIGRATION_PLAN.md       # План миграции
│   └── TEST_STRUCTURE.md       # Структура тестов
└── CLAUDE.md                    # Контекст для Claude AI

```

## 📚 Документация

Детальная документация в директории `docs/`:

- [Архитектура системы](docs/ARCHITECTURE.md)
- [План миграции](docs/MIGRATION_PLAN.md)
- [Структура тестов](TEST_STRUCTURE.md)
- [История изменений](CHANGELOG.md)

## 🧪 Тестирование

```bash
# Все тесты
cargo test

# Только интеграционные тесты
cargo test --test "*"

# Конкретный тест
cargo test --test query_parser_test

# С выводом отладочной информации
cargo test -- --nocapture
```

## 🤝 Участие в разработке

Проект находится в активной разработке. Приветствуются контрибуции!

### Принципы разработки

1. **Честная неопределённость** - TypeResolution::Unknown лучше неправильного Inferred
2. **Эволюционность** - Каждая фаза даёт работающий функционал
3. **Модульность** - Новые анализаторы добавляются через traits
4. **Градуальность** - Начинаем со статики, добавляем динамику где нужно

## 📚 Документация

- [ARCHITECTURE.md](docs/ARCHITECTURE.md) - Архитектура системы
- [VISUALIZATION.md](docs/VISUALIZATION.md) - Визуализация и отчёты
- [MIGRATION_PLAN.md](docs/MIGRATION_PLAN.md) - План миграции
- [parser_recommendations.md](docs/parser_recommendations.md) - Рекомендации по парсеру
- [CLAUDE.md](CLAUDE.md) - Контекст для AI-ассистента

### Визуализация системы типов

Проект предоставляет интерактивные HTML визуализации:

```bash
# Генерация визуализаций
cargo run --example generate_proper_hierarchy    # Правильная иерархия языка
cargo run --example generate_tree_hierarchy      # Древовидная структура
cargo run --example generate_enhanced_report     # Расширенный отчёт с TypeRef
```

Подробнее см. [VISUALIZATION.md](docs/VISUALIZATION.md)

## 📄 Лицензия

MIT License - см. файл [LICENSE](LICENSE)

## 🔗 Связанные проекты

- [bsl_type_safety_analyzer](https://github.com/yourusername/bsl_type_safety_analyzer) - Предыдущая итерация
- [1c-syntax](https://github.com/1c-syntax) - Инструменты для BSL

## 📊 Статус

**Текущая версия**: 0.4.0  
**Текущая фаза**: Phase 3.5 (90% готово) / Phase 4 планируется  
**Статус**: Активная разработка  
**Поддержка платформы**: 1С:Предприятие 8.3.20+

### Последние достижения
- ✅ Полный парсер BSL с поддержкой всего синтаксиса
- ✅ Парсер языка запросов 1С с временными таблицами
- ✅ Парсер синтакс-помощника с извлечением 476 функций и 22 ключевых слов
- ✅ Система TypeRef для нормализации типов (language:, context:, metadata_ref:)
- ✅ Интеграция с FacetRegistry для динамической регистрации фасетов
- ✅ Визуализация с правильной иерархией языковых конструкций
- ✅ Движок вывода типов с уровнями уверенности
- ✅ LSP сервер с диагностикой и автодополнением

### Метрики производительности
- Загрузка конфигурации с 1000+ объектами: < 1 сек
- Ответ LSP на автодополнение: < 100ms
- Парсинг BSL файла 10000 строк: < 500ms
- Анализ пакета из 10 запросов: < 50ms